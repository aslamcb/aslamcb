<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RenkoSizer ‚Äî Portable Renko Box Calculator</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0a0e17;--card:#141c2e;--border:#1c2d48;--border2:#2a3f5f;--text:#e2e8f0;--muted:#64748b;--dim:#384860;--green:#00e676;--red:#ff5252;--blue:#448aff;--amber:#ffab40;--cyan:#00bcd4;--rose:#f44336;--purple:#7c4dff}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh}
.mono{font-family:'Cascadia Code','Fira Code','Consolas',monospace}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

header{border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;background:rgba(10,14,23,.9);backdrop-filter:blur(8px)}
header h1{font-size:18px;font-weight:700;color:#fff}
header h1 span{color:var(--blue)}
header .sub{font-size:10px;color:var(--muted);margin-left:12px}
#live{color:var(--blue);font-size:10px;display:none;align-items:center;gap:4px}
#live .dot{width:6px;height:6px;border-radius:50%;background:var(--blue);animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

main{max-width:1280px;margin:0 auto;padding:16px}
.section{margin-bottom:24px}
.section-title{font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.section-title::before,.section-title::after{content:'';flex:1;height:1px;background:var(--border)}

/* Search */
.search-wrap{position:relative;max-width:560px;margin-bottom:16px}
#search{width:100%;padding:10px 12px 10px 36px;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;outline:none}
#search:focus{border-color:var(--blue)}
#search::placeholder{color:var(--dim)}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:14px}
#results{position:absolute;top:100%;left:0;right:0;background:var(--bg);border:1px solid var(--border);border-radius:10px;max-height:360px;overflow-y:auto;z-index:100;display:none;margin-top:4px}
#results .item{padding:8px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
#results .item:hover,#results .item.active{background:var(--card)}
#results .item .sym{font-weight:600;font-size:14px}
#results .item .name{font-size:11px;color:var(--muted);margin-left:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#results .item .badge{font-size:9px;padding:2px 6px;border-radius:4px;background:var(--border);color:var(--muted);white-space:nowrap}

/* Quick picks */
.quick-picks{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.quick-picks button{padding:8px 14px;border-radius:10px;background:var(--card);border:1px solid var(--border);color:var(--muted);cursor:pointer;text-align:left;font-size:13px}
.quick-picks button:hover{border-color:var(--blue);color:#fff}
.quick-picks button .ql{display:block;font-size:10px;color:var(--dim);margin-top:2px}

/* Instrument info */
#info-bar{display:none;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
#info-bar .row1{display:flex;flex-wrap:wrap;align-items:baseline;gap:12px;margin-bottom:12px}
#info-bar .sym{font-size:20px;font-weight:700;color:#fff}
#info-bar .exch{font-size:11px;color:var(--muted)}
#info-bar .price{font-size:24px;font-weight:700;color:#fff}
#info-bar .chg{font-size:13px;font-weight:600}
#info-bar .chg.up{color:var(--green)}
#info-bar .chg.dn{color:var(--red)}
.chips{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.chip{background:var(--card);border-radius:8px;padding:6px 10px}
.chip .cl{font-size:9px;text-transform:uppercase;letter-spacing:.8px;color:var(--muted)}
.chip .cv{font-size:13px;font-weight:600;color:var(--text)}

/* Price input manual */
#manual-price{display:none;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:16px;font-size:12px;color:var(--amber)}
#manual-price input{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--text);width:120px;margin:0 6px;font-size:13px}
#manual-price button{background:var(--blue);color:#fff;border:none;border-radius:6px;padding:6px 14px;cursor:pointer;font-size:12px}

/* Grid of cards */
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.box-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;transition:border-color .2s;border-top:3px solid var(--border)}
.box-card:hover{border-color:var(--border2)}
.box-card .tf-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.box-card .tf-hold{font-size:9px;color:var(--muted);font-weight:400;text-transform:none;letter-spacing:0}
.box-card .big-num{font-size:28px;font-weight:700;margin-bottom:2px}
.box-card .pts{font-size:10px;color:var(--muted)}
.methods{margin:8px 0}
.methods .mrow{display:flex;justify-content:space-between;align-items:center;padding:4px 8px;border-radius:4px;background:var(--bg);margin-bottom:3px;font-size:11px}
.pct-row{display:grid;grid-template-columns:repeat(5,1fr);gap:3px;margin:8px 0;text-align:center}
.pct-row .pc{background:var(--bg);border-radius:4px;padding:3px}
.pct-row .pc .pl{font-size:8px;color:var(--dim)}
.pct-row .pc .pv{font-size:10px;color:var(--muted)}
.sl-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 12px;padding-top:8px;border-top:1px solid var(--border);font-size:10px}
.sl-grid .sl{color:var(--muted)}
.sl-grid .sv{font-weight:500}
.sv.red{color:var(--red)}

/* Table */
.tbl-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:12px}
table{width:100%;border-collapse:collapse;font-size:12px;white-space:nowrap}
th{background:var(--bg);padding:8px 10px;text-align:right;font-size:9px;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-weight:600;position:sticky;top:0;z-index:5}
th:first-child{text-align:left;position:sticky;left:0;z-index:10;background:var(--bg)}
td{padding:6px 10px;border-top:1px solid var(--border);text-align:right}
td:first-child{text-align:left;position:sticky;left:0;background:var(--bg);z-index:2;font-weight:600}
tr:hover td{background:var(--card)}
.trad{color:var(--amber)}
.prof{color:var(--cyan)}
.drd{color:#ef5350}
.rec{color:var(--green);font-weight:700;font-size:14px}
.sl-col{color:#ef5350}
.tar-col{color:var(--blue)}

/* Formula */
.formula{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:16px;font-size:12px}
.formula h4{font-size:11px;font-weight:600;margin-bottom:4px}
.formula .methods-desc{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-bottom:16px}
.formula .md{background:var(--card);border-radius:8px;padding:10px}
.formula .md p{color:var(--muted);line-height:1.6;margin-top:4px}
.rules{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.rules .r{display:flex;gap:6px;color:var(--muted)}
.rules .r b{color:var(--text)}
.rules .r .n{color:var(--green);flex-shrink:0}

/* Export */
.export-btn{background:transparent;border:1px solid var(--border);color:var(--muted);padding:6px 12px;border-radius:8px;cursor:pointer;font-size:11px}
.export-btn:hover{color:#fff;background:var(--card)}

/* Empty state */
#empty{text-align:center;padding:60px 20px}
#empty .icon{width:64px;height:64px;border-radius:50%;background:var(--card);display:inline-flex;align-items:center;justify-content:center;margin-bottom:16px;font-size:28px}
#empty h2{color:#ccc;font-size:18px;margin-bottom:6px}
#empty p{color:var(--muted);font-size:13px;max-width:400px;margin:0 auto}

#content{display:none}

footer{border-top:1px solid var(--border);padding:16px;text-align:center;font-size:10px;color:var(--dim);margin-top:40px}

@media(max-width:640px){
  .card-grid{grid-template-columns:1fr}
  .rules{grid-template-columns:1fr}
  .chips{grid-template-columns:repeat(2,1fr)}
  .formula .methods-desc{grid-template-columns:1fr}
}
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center">
    <h1 class="mono"><span>&#x25B2;</span> RenkoSizer</h1>
    <span class="sub mono">Portable ¬∑ % of LTP + Traditional + Professional + Dr Devendra</span>
  </div>
  <div id="live"><div class="dot"></div><span class="mono">LIVE</span></div>
</header>

<main>

<!-- Search -->
<div class="section">
  <div class="search-wrap">
    <span class="search-icon">&#x1F50D;</span>
    <input type="text" id="search" class="mono" placeholder="Search instruments... (NIFTY, RELIANCE, GOLD, etc.)" autocomplete="off">
    <div id="results"></div>
  </div>

  <div class="quick-picks">
    <button onclick="selectInstrument('NIFTY')">NIFTY<span class="ql">Nifty 50 ¬∑ Lot 65</span></button>
    <button onclick="selectInstrument('BANKNIFTY')">BANKNIFTY<span class="ql">Bank Nifty ¬∑ Lot 30</span></button>
    <button onclick="selectInstrument('RELIANCE')">RELIANCE<span class="ql">Reliance ¬∑ Lot 500</span></button>
    <button onclick="selectInstrument('GOLD')">GOLD<span class="ql">MCX Gold ¬∑ Lot 100</span></button>
    <button onclick="selectInstrument('SBIN')">SBIN<span class="ql">SBI ¬∑ Lot 750</span></button>
    <button onclick="selectInstrument('TATAMOTORS')">TATAMOTORS<span class="ql">Tata Motors ¬∑ Lot 800</span></button>
  </div>
</div>

<!-- Info bar -->
<div id="info-bar">
  <div class="row1">
    <span class="sym mono" id="i-sym"></span>
    <span class="exch" id="i-exch"></span>
    <span class="price mono" id="i-price"></span>
    <span class="chg mono" id="i-chg"></span>
  </div>
  <div class="chips" id="i-chips"></div>
</div>

<!-- Manual price fallback -->
<div id="manual-price">
  &#9888; Could not fetch live price. Enter LTP manually:
  <input type="number" id="mp-input" class="mono" step="0.05" placeholder="Price">
  <button onclick="applyManualPrice()">Apply</button>
</div>

<!-- Empty state -->
<div id="empty">
  <div class="icon">&#x26A1;</div>
  <h2>Select an Instrument</h2>
  <p>Pick any NSE index, F&O stock, or MCX commodity to calculate Renko box sizes across 12 timeframes using 4 methods.</p>
</div>

<!-- Content -->
<div id="content">
  <!-- Cards -->
  <div class="section">
    <div class="section-title">Renko Box Sizes by Timeframe</div>
    <div class="card-grid" id="card-grid"></div>
  </div>

  <!-- Table -->
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div class="section-title" style="margin:0">Full Comparison</div>
      <button class="export-btn" onclick="exportCSV()">&#x2B73; Export CSV</button>
    </div>
    <div class="tbl-wrap"><table id="cmp-table"></table></div>
  </div>

  <!-- Formula -->
  <div class="section">
    <div class="formula">
      <div class="section-title" style="margin-bottom:12px">Calculation Methods & Renko Rules</div>
      <div class="methods-desc">
        <div class="md"><h4 style="color:var(--amber)">Traditional (1/N of Price)</h4><p>TradingView standard "1/20th of price" rule for 1H, scaled proportionally per timeframe. The most widely accepted starting point.</p></div>
        <div class="md"><h4 style="color:var(--cyan)">Professional (Prashant Shah / Definedge)</h4><p>Price-level lookup table with absolute box values tuned per price range. Lower bricks for short-term, higher for long-term. Empirically tested on Indian markets.</p></div>
        <div class="md"><h4 style="color:#ef5350">Dr Devendra (Shadow Candle Theory)</h4><p>Non-repaintable Renko method. Index: 0.07% of LTP base; Stocks: 0.15% base (on 1-min), scaled per TF. For trend confirmation, use ~2x this value on a second chart.</p></div>
        <div class="md"><h4 style="color:var(--purple)">% of LTP (Reference)</h4><p>Your 5 fixed percentages (0.05%, 0.25%, 0.50%, 1%, 3%) applied to live LTP. Shown as reference to manually pick if preferred.</p></div>
      </div>
      <div class="rules">
        <div class="r"><span class="n">1.</span><span><b>Source = Close ONLY</b> ‚Äî Never use OHLC for Renko source</span></div>
        <div class="r"><span class="n">2.</span><span><b>Wait for brick close</b> ‚Äî Enter after color change is confirmed</span></div>
        <div class="r"><span class="n">3.</span><span><b>Fixed box size</b> ‚Äî Do NOT use auto-ATR (it repaints)</span></div>
        <div class="r"><span class="n">4.</span><span><b>Close-based construction</b> ‚Äî New brick only when close exceeds prev brick ¬± box size</span></div>
      </div>
    </div>
  </div>
</div>

</main>

<footer class="mono">RenkoSizer Portable v5.0 ‚Äî Open this file from Google Drive / OneDrive / Dropbox / any folder. No install needed.</footer>

<script>
// ==================== INSTRUMENT DATABASE ====================
const INSTRUMENTS = [
  // Index Futures
  {s:"NIFTY",n:"Nifty 50 Futures",lot:65,seg:"Index",ex:"NSE",yf:"^NSEI",isIdx:true},
  {s:"BANKNIFTY",n:"Bank Nifty Futures",lot:30,seg:"Index",ex:"NSE",yf:"^NSEBANK",isIdx:true},
  {s:"FINNIFTY",n:"Fin Nifty Futures",lot:60,seg:"Index",ex:"NSE",yf:"NIFTY_FIN_SERVICE.NS",isIdx:true},
  {s:"MIDCPNIFTY",n:"Midcap Nifty Futures",lot:120,seg:"Index",ex:"NSE",yf:"NIFTY_MID_SELECT.NS",isIdx:true},
  {s:"SENSEX",n:"Sensex Futures",lot:20,seg:"Index",ex:"BSE",yf:"^BSESN",isIdx:true},
  // MCX
  {s:"GOLD",n:"Gold",lot:100,seg:"MCX",ex:"MCX",yf:"GC=F",isIdx:false},
  {s:"GOLDM",n:"Gold Mini",lot:10,seg:"MCX",ex:"MCX",yf:"GC=F",isIdx:false},
  {s:"SILVER",n:"Silver",lot:30,seg:"MCX",ex:"MCX",yf:"SI=F",isIdx:false},
  {s:"SILVERM",n:"Silver Mini",lot:5,seg:"MCX",ex:"MCX",yf:"SI=F",isIdx:false},
  {s:"CRUDEOIL",n:"Crude Oil",lot:100,seg:"MCX",ex:"MCX",yf:"CL=F",isIdx:false},
  {s:"NATURALGAS",n:"Natural Gas",lot:1250,seg:"MCX",ex:"MCX",yf:"NG=F",isIdx:false},
  {s:"COPPER",n:"Copper",lot:2500,seg:"MCX",ex:"MCX",yf:"HG=F",isIdx:false},
  // F&O Stocks (Feb 2026 NSE lot sizes from OptionPerks.com)
  {s:"RELIANCE",n:"Reliance Industries",lot:500,seg:"F&O",ex:"NSE",yf:"RELIANCE.NS",isIdx:false},
  {s:"TCS",n:"Tata Consultancy Services",lot:175,seg:"F&O",ex:"NSE",yf:"TCS.NS",isIdx:false},
  {s:"HDFCBANK",n:"HDFC Bank",lot:550,seg:"F&O",ex:"NSE",yf:"HDFCBANK.NS",isIdx:false},
  {s:"INFY",n:"Infosys",lot:400,seg:"F&O",ex:"NSE",yf:"INFY.NS",isIdx:false},
  {s:"ICICIBANK",n:"ICICI Bank",lot:700,seg:"F&O",ex:"NSE",yf:"ICICIBANK.NS",isIdx:false},
  {s:"SBIN",n:"State Bank of India",lot:750,seg:"F&O",ex:"NSE",yf:"SBIN.NS",isIdx:false},
  {s:"BAJFINANCE",n:"Bajaj Finance",lot:750,seg:"F&O",ex:"NSE",yf:"BAJFINANCE.NS",isIdx:false},
  {s:"BHARTIARTL",n:"Bharti Airtel",lot:475,seg:"F&O",ex:"NSE",yf:"BHARTIARTL.NS",isIdx:false},
  {s:"ITC",n:"ITC Limited",lot:1600,seg:"F&O",ex:"NSE",yf:"ITC.NS",isIdx:false},
  {s:"LT",n:"Larsen & Toubro",lot:175,seg:"F&O",ex:"NSE",yf:"LT.NS",isIdx:false},
  {s:"AXISBANK",n:"Axis Bank",lot:625,seg:"F&O",ex:"NSE",yf:"AXISBANK.NS",isIdx:false},
  {s:"KOTAKBANK",n:"Kotak Mahindra Bank",lot:2000,seg:"F&O",ex:"NSE",yf:"KOTAKBANK.NS",isIdx:false},
  {s:"HINDUNILVR",n:"Hindustan Unilever",lot:300,seg:"F&O",ex:"NSE",yf:"HINDUNILVR.NS",isIdx:false},
  {s:"MARUTI",n:"Maruti Suzuki",lot:50,seg:"F&O",ex:"NSE",yf:"MARUTI.NS",isIdx:false},
  {s:"TATASTEEL",n:"Tata Steel",lot:5500,seg:"F&O",ex:"NSE",yf:"TATASTEEL.NS",isIdx:false},
  {s:"WIPRO",n:"Wipro",lot:3000,seg:"F&O",ex:"NSE",yf:"WIPRO.NS",isIdx:false},
  {s:"ADANIENT",n:"Adani Enterprises",lot:309,seg:"F&O",ex:"NSE",yf:"ADANIENT.NS",isIdx:false},
  {s:"TATAMOTORS",n:"Tata Motors",lot:800,seg:"F&O",ex:"NSE",yf:"TATAMOTORS.NS",isIdx:false},
  {s:"SUNPHARMA",n:"Sun Pharma",lot:350,seg:"F&O",ex:"NSE",yf:"SUNPHARMA.NS",isIdx:false},
  {s:"M&M",n:"Mahindra & Mahindra",lot:200,seg:"F&O",ex:"NSE",yf:"M%26M.NS",isIdx:false},
  {s:"HAL",n:"Hindustan Aeronautics",lot:150,seg:"F&O",ex:"NSE",yf:"HAL.NS",isIdx:false},
  {s:"DLF",n:"DLF Limited",lot:825,seg:"F&O",ex:"NSE",yf:"DLF.NS",isIdx:false},
  {s:"TRENT",n:"Trent Limited",lot:100,seg:"F&O",ex:"NSE",yf:"TRENT.NS",isIdx:false},
  {s:"TITAN",n:"Titan Company",lot:175,seg:"F&O",ex:"NSE",yf:"TITAN.NS",isIdx:false},
  {s:"HCLTECH",n:"HCL Technologies",lot:350,seg:"F&O",ex:"NSE",yf:"HCLTECH.NS",isIdx:false},
  {s:"BAJAJFINSV",n:"Bajaj Finserv",lot:250,seg:"F&O",ex:"NSE",yf:"BAJAJFINSV.NS",isIdx:false},
  {s:"NTPC",n:"NTPC Limited",lot:1500,seg:"F&O",ex:"NSE",yf:"NTPC.NS",isIdx:false},
  {s:"POWERGRID",n:"Power Grid Corp",lot:1900,seg:"F&O",ex:"NSE",yf:"POWERGRID.NS",isIdx:false},
  {s:"ONGC",n:"Oil & Natural Gas",lot:2250,seg:"F&O",ex:"NSE",yf:"ONGC.NS",isIdx:false},
  {s:"JSWSTEEL",n:"JSW Steel",lot:675,seg:"F&O",ex:"NSE",yf:"JSWSTEEL.NS",isIdx:false},
  {s:"ASIANPAINT",n:"Asian Paints",lot:250,seg:"F&O",ex:"NSE",yf:"ASIANPAINT.NS",isIdx:false},
  {s:"TECHM",n:"Tech Mahindra",lot:600,seg:"F&O",ex:"NSE",yf:"TECHM.NS",isIdx:false},
  {s:"ULTRACEMCO",n:"UltraTech Cement",lot:50,seg:"F&O",ex:"NSE",yf:"ULTRACEMCO.NS",isIdx:false},
  {s:"ADANIPORTS",n:"Adani Ports",lot:475,seg:"F&O",ex:"NSE",yf:"ADANIPORTS.NS",isIdx:false},
  {s:"COALINDIA",n:"Coal India",lot:1350,seg:"F&O",ex:"NSE",yf:"COALINDIA.NS",isIdx:false},
  {s:"DRREDDY",n:"Dr. Reddy's Labs",lot:625,seg:"F&O",ex:"NSE",yf:"DRREDDY.NS",isIdx:false},
  {s:"CIPLA",n:"Cipla Limited",lot:375,seg:"F&O",ex:"NSE",yf:"CIPLA.NS",isIdx:false},
  {s:"EICHERMOT",n:"Eicher Motors",lot:100,seg:"F&O",ex:"NSE",yf:"EICHERMOT.NS",isIdx:false},
  {s:"DIVISLAB",n:"Divi's Labs",lot:100,seg:"F&O",ex:"NSE",yf:"DIVISLAB.NS",isIdx:false},
  {s:"BPCL",n:"Bharat Petroleum",lot:1975,seg:"F&O",ex:"NSE",yf:"BPCL.NS",isIdx:false},
  {s:"APOLLOHOSP",n:"Apollo Hospitals",lot:125,seg:"F&O",ex:"NSE",yf:"APOLLOHOSP.NS",isIdx:false},
  {s:"HEROMOTOCO",n:"Hero MotoCorp",lot:150,seg:"F&O",ex:"NSE",yf:"HEROMOTOCO.NS",isIdx:false},
  {s:"BRITANNIA",n:"Britannia Industries",lot:125,seg:"F&O",ex:"NSE",yf:"BRITANNIA.NS",isIdx:false},
  {s:"NESTLEIND",n:"Nestle India",lot:500,seg:"F&O",ex:"NSE",yf:"NESTLEIND.NS",isIdx:false},
  {s:"TATACONSUM",n:"Tata Consumer",lot:550,seg:"F&O",ex:"NSE",yf:"TATACONSUM.NS",isIdx:false},
  {s:"HINDALCO",n:"Hindalco Industries",lot:700,seg:"F&O",ex:"NSE",yf:"HINDALCO.NS",isIdx:false},
  {s:"INDUSINDBK",n:"IndusInd Bank",lot:700,seg:"F&O",ex:"NSE",yf:"INDUSINDBK.NS",isIdx:false},
  {s:"SIEMENS",n:"Siemens",lot:175,seg:"F&O",ex:"NSE",yf:"SIEMENS.NS",isIdx:false},
  {s:"BEL",n:"Bharat Electronics",lot:1425,seg:"F&O",ex:"NSE",yf:"BEL.NS",isIdx:false},
  {s:"BANKBARODA",n:"Bank of Baroda",lot:2925,seg:"F&O",ex:"NSE",yf:"BANKBARODA.NS",isIdx:false},
  {s:"PNB",n:"Punjab National Bank",lot:8000,seg:"F&O",ex:"NSE",yf:"PNB.NS",isIdx:false},
  {s:"TATAPOWER",n:"Tata Power",lot:1450,seg:"F&O",ex:"NSE",yf:"TATAPOWER.NS",isIdx:false},
  {s:"IRCTC",n:"IRCTC",lot:875,seg:"F&O",ex:"NSE",yf:"IRCTC.NS",isIdx:false},
  {s:"ETERNAL",n:"Zomato (Eternal)",lot:2425,seg:"F&O",ex:"NSE",yf:"ETERNAL.NS",isIdx:false},
  {s:"POLYCAB",n:"Polycab India",lot:125,seg:"F&O",ex:"NSE",yf:"POLYCAB.NS",isIdx:false},
  {s:"ABB",n:"ABB India",lot:125,seg:"F&O",ex:"NSE",yf:"ABB.NS",isIdx:false},
  {s:"JINDALSTEL",n:"Jindal Steel & Power",lot:625,seg:"F&O",ex:"NSE",yf:"JINDALSTEL.NS",isIdx:false},
  {s:"RECLTD",n:"REC Limited",lot:1400,seg:"F&O",ex:"NSE",yf:"RECLTD.NS",isIdx:false},
  {s:"PFC",n:"Power Finance Corp",lot:1300,seg:"F&O",ex:"NSE",yf:"PFC.NS",isIdx:false},
  {s:"NHPC",n:"NHPC Limited",lot:6400,seg:"F&O",ex:"NSE",yf:"NHPC.NS",isIdx:false},
  {s:"GAIL",n:"GAIL India",lot:3150,seg:"F&O",ex:"NSE",yf:"GAIL.NS",isIdx:false},
  {s:"SAIL",n:"SAIL",lot:4700,seg:"F&O",ex:"NSE",yf:"SAIL.NS",isIdx:false},
  {s:"BHEL",n:"BHEL",lot:2625,seg:"F&O",ex:"NSE",yf:"BHEL.NS",isIdx:false},
  {s:"INDIGO",n:"InterGlobe Aviation",lot:150,seg:"F&O",ex:"NSE",yf:"INDIGO.NS",isIdx:false},
  {s:"CHOLAFIN",n:"Cholamandalam Finance",lot:625,seg:"F&O",ex:"NSE",yf:"CHOLAFIN.NS",isIdx:false},
  {s:"SHRIRAMFIN",n:"Shriram Finance",lot:825,seg:"F&O",ex:"NSE",yf:"SHRIRAMFIN.NS",isIdx:false},
  {s:"PERSISTENT",n:"Persistent Systems",lot:100,seg:"F&O",ex:"NSE",yf:"PERSISTENT.NS",isIdx:false},
  {s:"LTIM",n:"LTIMindtree",lot:150,seg:"F&O",ex:"NSE",yf:"LTIM.NS",isIdx:false},
  {s:"COFORGE",n:"Coforge",lot:375,seg:"F&O",ex:"NSE",yf:"COFORGE.NS",isIdx:false},
  {s:"DIXON",n:"Dixon Technologies",lot:50,seg:"F&O",ex:"NSE",yf:"DIXON.NS",isIdx:false},
  {s:"DMART",n:"Avenue Supermarts",lot:150,seg:"F&O",ex:"NSE",yf:"DMART.NS",isIdx:false},
  {s:"PAGEIND",n:"Page Industries",lot:15,seg:"F&O",ex:"NSE",yf:"PAGEIND.NS",isIdx:false},
];

// ==================== TIMEFRAME CONFIGS ====================
const TF = [
  {k:"tf15s",l:"15-Second",sl:"15s",tp:0.015,sb:2,tb:3,ht:"15s‚Äì1min",i:"‚ö°",c:"#ff1744"},
  {k:"tf30s",l:"30-Second",sl:"30s",tp:0.025,sb:2,tb:3,ht:"30s‚Äì2min",i:"‚ö°",c:"#ff5252"},
  {k:"tf1m",l:"1-Minute",sl:"1m",tp:0.040,sb:2,tb:3,ht:"1‚Äì5min",i:"üî•",c:"#ff6e40"},
  {k:"tf3m",l:"3-Minute",sl:"3m",tp:0.075,sb:2,tb:3,ht:"3‚Äì10min",i:"üî•",c:"#ffab40"},
  {k:"tf5m",l:"5-Minute",sl:"5m",tp:0.120,sb:2,tb:4,ht:"5‚Äì30min",i:"üìä",c:"#ffd740"},
  {k:"tf10m",l:"10-Minute",sl:"10m",tp:0.200,sb:3,tb:4,ht:"10‚Äì45min",i:"üìä",c:"#eeff41"},
  {k:"tf15m",l:"15-Minute",sl:"15m",tp:0.300,sb:3,tb:4,ht:"15min‚Äì1hr",i:"üìà",c:"#69f0ae"},
  {k:"tf30m",l:"30-Minute",sl:"30m",tp:0.500,sb:3,tb:4,ht:"30min‚Äì2hr",i:"üéØ",c:"#00e676"},
  {k:"tf1h",l:"1-Hour",sl:"1H",tp:0.750,sb:3,tb:5,ht:"1‚Äì4hr",i:"üïê",c:"#00bfa5"},
  {k:"tf2h",l:"2-Hour",sl:"2H",tp:1.000,sb:3,tb:5,ht:"2‚Äì8hr",i:"üåä",c:"#448aff"},
  {k:"tf4h",l:"4-Hour",sl:"4H",tp:1.500,sb:4,tb:6,ht:"4hr‚Äì2d",i:"üåä",c:"#536dfe"},
  {k:"daily",l:"Daily",sl:"D",tp:2.500,sb:4,tb:6,ht:"1‚Äì5d",i:"üèî",c:"#7c4dff"},
];

const PCT = [0.05, 0.25, 0.50, 1.00, 3.00];
const PCT_L = ["0.05%","0.25%","0.50%","1%","3%"];
const DD_SCALE = [0.5,0.7,1.0,1.5,2.0,3.0,4.0,6.0,8.0,12.0,18.0,30.0];

// ==================== SMART ROUND ====================
function sr(v, p) {
  if (v <= 0) return 0.05;
  if (p >= 30000) return Math.round(v/5)*5 || 5;
  if (p >= 10000) return Math.round(v/2)*2 || 2;
  if (p >= 1000) return Math.round(v) || 1;
  if (p >= 100) return Math.round(v*2)/2 || 0.5;
  if (p >= 10) return Math.round(v*4)/4 || 0.25;
  return Math.round(v*10)/10 || 0.1;
}
function fb(v) {
  if (v >= 100) return v.toFixed(0);
  if (v >= 10) return v.toFixed(1);
  return v.toFixed(2);
}
function inr(v) { return v.toLocaleString('en-IN',{maximumFractionDigits:0}); }

// ==================== PROFESSIONAL TABLE ====================
function profTable(p) {
  let r;
  if (p>=50000) r=[5,10,15,25,40,60,100,150,200,300,500,800];
  else if(p>=20000) r=[3,5,10,18,25,40,60,100,150,200,350,600];
  else if(p>=10000) r=[2,3,5,10,15,25,40,60,100,150,250,400];
  else if(p>=5000) r=[1,2,3,5,8,12,20,30,50,75,120,200];
  else if(p>=2000) r=[.5,1,1.5,3,5,8,12,20,30,50,80,150];
  else if(p>=1000) r=[.25,.5,1,2,3,5,8,12,20,30,50,100];
  else if(p>=500) r=[.25,.5,.5,1,2,3,5,8,12,20,30,50];
  else if(p>=200) r=[.1,.25,.5,.5,1,2,3,5,8,12,20,30];
  else if(p>=100) r=[.1,.25,.25,.5,1,1.5,2,3,5,8,15,25];
  else if(p>=50) r=[.05,.1,.1,.25,.5,.75,1,2,3,5,8,15];
  else r=[.05,.05,.1,.1,.25,.5,.5,1,2,3,5,10];
  return r;
}

// ==================== CALCULATOR ====================
function calculate(inst, price) {
  const p = price;
  const lot = inst.lot;
  const isIdx = inst.isIdx;
  const pctBoxes = PCT.map(pc => sr(p * pc / 100, p));
  const proRow = profTable(p);
  const ddBase = isIdx ? 0.07 : 0.15;

  return TF.map((tf, i) => {
    const trad = sr(p * tf.tp / 100, p);
    const prof = proRow[i];
    const dd = sr(p * ddBase * DD_SCALE[i] / 100, p);
    const rec = sr((trad + prof) / 2, p);
    const slPts = rec * tf.sb;
    const tarPts = rec * tf.tb;
    return {
      tf, trad, prof, dd, rec,
      p005:pctBoxes[0], p025:pctBoxes[1], p050:pctBoxes[2], p100:pctBoxes[3], p300:pctBoxes[4],
      slPts, slLot: slPts*lot, tarPts, boxLot: rec*lot,
      rr: tf.sb>0 ? (tf.tb/tf.sb).toFixed(1) : '0'
    };
  });
}

// ==================== FETCH PRICE ====================
let currentInst = null;

async function fetchPrice(inst) {
  const proxies = [
    `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(inst.yf)}?interval=1d&range=1d`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${inst.yf}?interval=1d&range=1d`)}`,
  ];

  for (const url of proxies) {
    try {
      const r = await fetch(url);
      if (!r.ok) continue;
      const j = await r.json();
      const meta = j?.chart?.result?.[0]?.meta;
      if (meta?.regularMarketPrice) {
        return {
          price: meta.regularMarketPrice,
          prevClose: meta.chartPreviousClose || meta.previousClose || 0,
          high: meta.regularMarketDayHigh || 0,
          low: meta.regularMarketDayLow || 0,
          vol: meta.regularMarketVolume || 0,
        };
      }
    } catch(e) { continue; }
  }
  return null;
}

// ==================== SELECT INSTRUMENT ====================
async function selectInstrument(symbol) {
  const inst = INSTRUMENTS.find(i => i.s === symbol);
  if (!inst) return;
  currentInst = inst;

  document.getElementById('search').value = '';
  document.getElementById('results').style.display = 'none';

  document.getElementById('info-bar').style.display = 'block';
  document.getElementById('i-sym').textContent = inst.s;
  document.getElementById('i-exch').textContent = inst.ex + ' ¬∑ ' + inst.seg;
  document.getElementById('i-price').textContent = 'Loading...';
  document.getElementById('i-chg').textContent = '';
  document.getElementById('i-chips').innerHTML = '';
  document.getElementById('empty').style.display = 'none';
  document.getElementById('content').style.display = 'none';
  document.getElementById('manual-price').style.display = 'none';

  const q = await fetchPrice(inst);
  if (q) {
    document.getElementById('live').style.display = 'flex';
    renderWithPrice(inst, q.price, q);
  } else {
    document.getElementById('live').style.display = 'none';
    document.getElementById('i-price').textContent = '‚Äî';
    document.getElementById('manual-price').style.display = 'block';
    document.getElementById('mp-input').value = '';
    document.getElementById('mp-input').focus();
  }
}

function applyManualPrice() {
  const v = parseFloat(document.getElementById('mp-input').value);
  if (!v || !currentInst) return;
  document.getElementById('manual-price').style.display = 'none';
  renderWithPrice(currentInst, v, null);
}

function renderWithPrice(inst, price, q) {
  document.getElementById('i-price').textContent = '‚Çπ' + price.toLocaleString('en-IN',{maximumFractionDigits:2});
  if (q && q.prevClose) {
    const chg = price - q.prevClose;
    const chgPct = (chg/q.prevClose*100);
    const el = document.getElementById('i-chg');
    el.textContent = (chg>=0?'+':'') + chg.toFixed(2) + ' (' + chgPct.toFixed(2) + '%)';
    el.className = 'chg mono ' + (chg>=0?'up':'dn');
  }

  const chips = document.getElementById('i-chips');
  const range = q ? (q.high - q.low) : 0;
  chips.innerHTML = [
    ['Day Range', q ? '‚Çπ'+range.toFixed(2) : '‚Äî'],
    ['High', q ? '‚Çπ'+q.high.toLocaleString('en-IN') : '‚Äî'],
    ['Low', q ? '‚Çπ'+q.low.toLocaleString('en-IN') : '‚Äî'],
    ['Lot Size', inst.lot.toLocaleString()],
    ['Volume', q ? inr(q.vol) : '‚Äî'],
  ].map(([l,v]) => `<div class="chip"><div class="cl">${l}</div><div class="cv mono">${v}</div></div>`).join('');

  const data = calculate(inst, price);
  renderCards(data, inst.lot);
  renderTable(data, inst, price);
  document.getElementById('content').style.display = 'block';
}

// ==================== RENDER CARDS ====================
function renderCards(data, lot) {
  document.getElementById('card-grid').innerHTML = data.map(d => `
    <div class="box-card" style="border-top-color:${d.tf.c}">
      <div class="tf-label" style="color:${d.tf.c}">
        ${d.tf.i} ${d.tf.l}
        <span class="tf-hold">${d.tf.ht}</span>
      </div>
      <div class="big-num mono" style="color:${d.tf.c}">${fb(d.rec)}</div>
      <div class="pts mono">points / box (recommended)</div>
      <div class="methods">
        <div class="mrow"><span class="trad">Traditional</span><span class="mono trad">${fb(d.trad)}</span></div>
        <div class="mrow"><span class="prof">Professional</span><span class="mono prof">${fb(d.prof)}</span></div>
        <div class="mrow"><span class="drd">Dr Devendra</span><span class="mono drd">${fb(d.dd)}</span></div>
      </div>
      <div class="pct-row mono">${PCT_L.map((l,i) => `<div class="pc"><div class="pl">${l}</div><div class="pv">${fb(d['p00'+[5,25,50][i]]||d['p'+[0,0,0,100,300][i]]||[d.p005,d.p025,d.p050,d.p100,d.p300][i])}</div></div>`).join('')}</div>
      <div class="sl-grid mono">
        <div><span class="sl">SL (${d.tf.sb} box)</span></div><div><span class="sv">${d.slPts.toFixed(1)} pts</span></div>
        <div><span class="sl">Target (${d.tf.tb} box)</span></div><div><span class="sv">${d.tarPts.toFixed(1)} pts</span></div>
        <div><span class="sl">SL/Lot</span></div><div><span class="sv red">‚Çπ${inr(d.slLot)}</span></div>
        <div><span class="sl">Box/Lot</span></div><div><span class="sv">‚Çπ${inr(d.boxLot)}</span></div>
      </div>
    </div>
  `).join('');
}

// Fix pct rendering in cards
function renderCards(data, lot) {
  document.getElementById('card-grid').innerHTML = data.map(d => {
    const pcts = [d.p005,d.p025,d.p050,d.p100,d.p300];
    return `
    <div class="box-card" style="border-top-color:${d.tf.c}">
      <div class="tf-label" style="color:${d.tf.c}">
        ${d.tf.i} ${d.tf.l}
        <span class="tf-hold">${d.tf.ht}</span>
      </div>
      <div class="big-num mono" style="color:${d.tf.c}">${fb(d.rec)}</div>
      <div class="pts mono">points / box (recommended)</div>
      <div class="methods">
        <div class="mrow"><span class="trad">Traditional</span><span class="mono trad">${fb(d.trad)}</span></div>
        <div class="mrow"><span class="prof">Professional</span><span class="mono prof">${fb(d.prof)}</span></div>
        <div class="mrow"><span class="drd">Dr Devendra</span><span class="mono drd">${fb(d.dd)}</span></div>
      </div>
      <div class="pct-row mono">${PCT_L.map((l,i) => `<div class="pc"><div class="pl">${l}</div><div class="pv">${fb(pcts[i])}</div></div>`).join('')}</div>
      <div class="sl-grid mono">
        <div><span class="sl">SL (${d.tf.sb} box)</span></div><div><span class="sv">${d.slPts.toFixed(1)} pts</span></div>
        <div><span class="sl">Target (${d.tf.tb} box)</span></div><div><span class="sv">${d.tarPts.toFixed(1)} pts</span></div>
        <div><span class="sl">SL/Lot</span></div><div><span class="sv red">‚Çπ${inr(d.slLot)}</span></div>
        <div><span class="sl">Box/Lot</span></div><div><span class="sv">‚Çπ${inr(d.boxLot)}</span></div>
      </div>
    </div>`;
  }).join('');
}

// ==================== RENDER TABLE ====================
let lastData = null, lastInst = null, lastPrice = 0;
function renderTable(data, inst, price) {
  lastData = data; lastInst = inst; lastPrice = price;
  const h = `<thead><tr>
    <th>Timeframe</th><th class="trad">Traditional</th><th class="prof">Professional</th>
    <th class="drd">Dr Devendra</th><th class="rec">Rec.</th>
    ${PCT_L.map(l=>`<th style="color:var(--dim)">${l}</th>`).join('')}
    <th>SL</th><th>SL/Lot</th><th>Target</th><th>Hold</th>
  </tr></thead>`;
  const b = data.map(d => {
    const pcts = [d.p005,d.p025,d.p050,d.p100,d.p300];
    return `<tr>
      <td style="color:${d.tf.c}">${d.tf.i} ${d.tf.l}</td>
      <td class="mono trad">${fb(d.trad)}</td>
      <td class="mono prof">${fb(d.prof)}</td>
      <td class="mono drd">${fb(d.dd)}</td>
      <td class="mono rec">${fb(d.rec)}</td>
      ${pcts.map(v=>`<td class="mono" style="color:var(--dim)">${fb(v)}</td>`).join('')}
      <td class="mono sl-col">${d.slPts.toFixed(1)}</td>
      <td class="mono sl-col">‚Çπ${inr(d.slLot)}</td>
      <td class="mono tar-col">${d.tarPts.toFixed(1)}</td>
      <td style="color:var(--muted);font-size:10px">${d.tf.ht}</td>
    </tr>`;
  }).join('');
  document.getElementById('cmp-table').innerHTML = h + '<tbody>' + b + '</tbody>';
}

// ==================== EXPORT CSV ====================
function exportCSV() {
  if (!lastData) return;
  const hdr = ["Timeframe","Traditional","Professional","Dr Devendra","Recommended",...PCT_L,"SL Pts","SL/Lot","Target Pts","Hold"];
  const rows = lastData.map(d => {
    const pcts = [d.p005,d.p025,d.p050,d.p100,d.p300];
    return [d.tf.l,d.trad,d.prof,d.dd,d.rec,...pcts,d.slPts.toFixed(1),d.slLot.toFixed(0),d.tarPts.toFixed(1),d.tf.ht];
  });
  const csv = [hdr,...rows].map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `renko-${lastInst.s}-box-sizes.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

// ==================== SEARCH ====================
const searchEl = document.getElementById('search');
const resultsEl = document.getElementById('results');
let selIdx = 0, filtered = [];

searchEl.addEventListener('input', function() {
  const q = this.value.trim().toLowerCase();
  if (!q) { resultsEl.style.display='none'; return; }
  filtered = INSTRUMENTS.filter(i =>
    i.s.toLowerCase().includes(q) || i.n.toLowerCase().includes(q)
  ).slice(0, 20);
  selIdx = 0;
  renderResults();
});
searchEl.addEventListener('keydown', function(e) {
  if (e.key==='ArrowDown') { e.preventDefault(); selIdx=Math.min(selIdx+1,filtered.length-1); renderResults(); }
  else if (e.key==='ArrowUp') { e.preventDefault(); selIdx=Math.max(selIdx-1,0); renderResults(); }
  else if (e.key==='Enter' && filtered[selIdx]) { selectInstrument(filtered[selIdx].s); }
  else if (e.key==='Escape') { resultsEl.style.display='none'; }
});
searchEl.addEventListener('focus', function() { if(this.value.trim()) { searchEl.dispatchEvent(new Event('input')); }});
document.addEventListener('click', function(e) { if(!e.target.closest('.search-wrap')) resultsEl.style.display='none'; });

function renderResults() {
  if (!filtered.length) { resultsEl.style.display='none'; return; }
  resultsEl.style.display = 'block';
  resultsEl.innerHTML = filtered.map((inst, i) =>
    `<div class="item${i===selIdx?' active':''}" onclick="selectInstrument('${inst.s}')">
      <div style="display:flex;align-items:center;min-width:0">
        <span class="sym mono">${inst.s}</span>
        <span class="name">${inst.n}</span>
      </div>
      <span class="badge">${inst.seg} ¬∑ Lot ${inst.lot}</span>
    </div>`
  ).join('');
}
</script>
</body>
</html>
